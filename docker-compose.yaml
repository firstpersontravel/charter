version: '3.7'
services:
  web:
    image: fpt:latest
    build: .
    expose: [80]
    ports: ["5000:80"]
    # uncomment all volumes to test baked version for deployment
    volumes:
      - ./static:/var/app/static
      - ./build:/var/app/build
      - ./apps/agency/static:/var/app/apps/agency/static
      - ./apps/travel/dist:/var/app/apps/travel/dist
      - ./docker/web/nginx.conf:/etc/nginx/nginx.conf
      - ./docker/web/conf:/etc/nginx/conf.d
    command: ["nginx", "-g", "daemon off;"]
    links: [server, pubsub]

  server:
    image: fpt:latest
    # uncomment all volumes to test baked version for deployment
    volumes:
      - ./fptcore/package.json:/var/app/fptcore/package.json
      - ./fptcore/migrations:/var/app/fptcore/migrations
      - ./fptcore/src:/var/app/fptcore/src
      - ./headquarters/package.json:/var/app/headquarters/package.json
      - ./headquarters/bin:/var/app/headquarters/bin
      - ./headquarters/cmd:/var/app/headquarters/cmd
      - ./headquarters/config:/var/app/headquarters/config
      - ./headquarters/examples:/var/app/headquarters/examples
      - ./headquarters/migrations:/var/app/headquarters/migrations
      - ./headquarters/src:/var/app/headquarters/src
      - ./headquarters/views:/var/app/headquarters/views
    env_file: [./secrets/env-local]
    environment:
      - PATH=/var/app/headquarters/node_modules/.bin:$PATH
    working_dir: /var/app/headquarters
    command: bash -c "nodemon --legacy-watch --polling-interval 1000 --watch /var/app/fptcore --watch /var/app/headquarters bin/server.js | pino -c"
    links: [mysql]
    depends_on: [mysql]

  worker:
    image: fpt:latest
    # uncomment all volumes to test baked version for deployment
    volumes:
      - ./fptcore/src:/var/app/fptcore/src
      - ./headquarters/bin:/var/app/headquarters/bin
      - ./headquarters/src:/var/app/headquarters/src
    env_file: [./secrets/env-local]
    environment:
      - PATH=/var/app/headquarters/node_modules/.bin:$PATH
    working_dir: /var/app/headquarters
    command: bash -c "nodemon --legacy-watch --polling-interval 1000 --watch /var/app/fptcore --watch /var/app/headquarters bin/worker.js | pino -c"
    links: [mysql]
    depends_on: [mysql]

  pubsub:
    image: fpt:latest
    # uncomment all volumes to test baked version for deployment
    volumes:
      - ./headquarters/bin:/var/app/headquarters/bin
      - ./headquarters/src:/var/app/headquarters/src
    env_file: [./secrets/env-local]
    environment:
      - PATH=/var/app/headquarters/node_modules/.bin:$PATH
    working_dir: /var/app/headquarters
    command: bash -c "node bin/pubsub.js | pino -c"

  mysql:
    image: mysql:5.7
    environment: [MYSQL_ROOT_PASSWORD=root]
    volumes: ["./docker/mysql:/docker-entrypoint-initdb.d"]
    ports: ["4310:3306"]

  # ngrok:
  #   image: wernight/ngrok
  #   ports:
  #     - "0.0.0.0:5000:5000"
  #   links:
  #     - "web"
  #   environment:
  #     - NGROK_AUTH=<>
  #     - NGROK_SUBDOMAIN=<>
  #     - NGROK_REGION=eu
  #     - NGROK_PORT=web:5000
