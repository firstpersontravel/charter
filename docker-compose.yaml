version: '3.7'
services:
  server:
    image: fpt:latest
    volumes:
      # Code
      - ./fptcore:/var/app/fptcore
      - ./headquarters:/var/app/headquarters
      - /var/app/headquarters/node_modules/bcrypt  # use bcrypt from container
      # Static assets
      - ./static:/var/app/static
      - ./build:/var/app/build
      - ./apps/agency/static:/var/app/apps/agency/static
      - ./apps/travel/dist:/var/app/apps/travel/dist
    env_file: [./secrets/env-local]
    environment:
      - PATH=/var/app/headquarters/node_modules/.bin:$PATH
    working_dir: /var/app/headquarters
    command: /bin/bash -c "nodemon --legacy-watch --polling-interval 1000 --watch /var/app/fptcore --watch /var/app/headquarters bin/server.js | pino -c"
    links: [mysql]
    depends_on: [mysql]
    ports: ["5001:5001"]

  worker:
    image: fpt:latest
    volumes:
      - ./fptcore:/var/app/fptcore
      - ./headquarters:/var/app/headquarters
      - /var/app/headquarters/node_modules/bcrypt  # use bcrypt from container
    env_file: [./secrets/env-local]
    environment:
      - PATH=/var/app/headquarters/node_modules/.bin:$PATH
    working_dir: /var/app/headquarters
    command: /bin/bash -c "nodemon --legacy-watch --polling-interval 1000 --watch /var/app/fptcore --watch /var/app/headquarters bin/worker.js | pino -c"
    links: [mysql]
    depends_on: [mysql]

  pubsub:
    image: fpt:latest
    volumes:
      - ./headquarters:/var/app/headquarters
    env_file: [./secrets/env-local]
    environment:
      - PATH=/var/app/headquarters/node_modules/.bin:$PATH
    working_dir: /var/app/headquarters
    command: /bin/bash -c "node bin/pubsub.js | pino -c"
    ports: ["5002:5002"]

  mysql:
    image: mysql:5.7
    environment: [MYSQL_ROOT_PASSWORD=root]
    volumes: ["./docker/mysql:/docker-entrypoint-initdb.d"]
    ports: ["4310:3306"]
